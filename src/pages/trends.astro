---
/**
 * Historical Trends & Comparison Page
 * Shows test result trends over time with filtering capabilities
 */

import Layout from '../layouts/Layout.astro';
import { getComposeIds, getComposeResults } from '@/lib/services/results';
import { extractVersion, formatPercent, formatDuration } from '@/lib/utils/formatters';
import type { TestResult } from '@/types';

// Fetch all compose results for historical analysis
const composeIds = await getComposeIds();

// Get results for all composes
const allResults: TestResult[] = [];
for (const composeId of composeIds) {
  const results = await getComposeResults(composeId);
  allResults.push(...results);
}

// Extract unique versions and architectures for filters
const versions = [...new Set(allResults.map(r => extractVersion(r.composeId)))].sort((a, b) => b.localeCompare(a));
const architectures = [...new Set(allResults.map(r => r.architecture))].sort();

// Group results by version and architecture for trend analysis
interface TrendDataPoint {
  composeId: string;
  version: string;
  architecture: string;
  passRate: number;
  passed: number;
  failed: number;
  skipped: number;
  total: number;
  timestamp: Date;
}

const trendData: TrendDataPoint[] = allResults.map(result => ({
  composeId: result.composeId,
  version: extractVersion(result.composeId),
  architecture: result.architecture,
  passRate: (result.summary.passed / result.summary.total) * 100,
  passed: result.summary.passed,
  failed: result.summary.failed,
  skipped: result.summary.skipped,
  total: result.summary.total,
  timestamp: new Date(result.timestamp)
}));

// Sort by timestamp descending (newest first)
trendData.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
---

<Layout title="Fedora Cloud Test Trends">
  <main class="trends-container">
    <!-- Header with Logos -->
    <header class="trends-header">
      <div class="logo-section">
        <div class="logo-container">
          <svg class="fedora-logo" viewBox="0 0 267 267" xmlns="http://www.w3.org/2000/svg">
            <path fill="#294172" d="M267 133.5C267 59.8 207.2 0 133.5 0S0 59.8 0 133.5 59.8 267 133.5 267 267 207.2 267 133.5z"/>
            <path fill="#3c6eb4" d="M133.5 245.3c-61.7 0-111.8-50.1-111.8-111.8S71.8 21.7 133.5 21.7 245.3 71.8 245.3 133.5 195.2 245.3 133.5 245.3z"/>
            <path fill="#fff" d="M133.5 200.8c-37.1 0-67.3-30.2-67.3-67.3s30.2-67.3 67.3-67.3 67.3 30.2 67.3 67.3-30.2 67.3-67.3 67.3z"/>
          </svg>
          <span class="brand-name">Fedora Cloud</span>
        </div>
        <div class="powered-by">
          <span class="powered-text">on</span>
          <svg class="azure-logo" viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="azure-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#0078d4;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#5ea0ef;stop-opacity:1" />
              </linearGradient>
            </defs>
            <path fill="url(#azure-grad)" d="M42.8 73.2L28 76.5c-1 .2-1.6-.5-1.3-1.5l19.4-57.1c.3-1 1.1-1.8 2.2-1.8h15.5c1 0 1.6.8 1.3 1.8L45.7 71.4c-.3 1-1.6 1.8-2.9 1.8z"/>
            <path fill="url(#azure-grad)" d="M74.7 73.2H48.1c-1 0-1.4-.8-.9-1.8L62.5 36c.5-1 1.9-1.8 3.1-1.8h21.5c1 0 1.4.8.9 1.8L72.7 71.4c-.5 1-1.9 1.8-3.1 1.8z" opacity=".8"/>
          </svg>
        </div>
      </div>
      
      <div class="header-content">
        <h1>Test Result Trends</h1>
        <p class="subtitle">Historical analysis of Fedora Cloud image testing on Azure</p>
      </div>
    </header>

    <!-- Filter Controls -->
    <section class="filter-section">
      <div class="filter-group">
        <label for="version-filter">
          <span class="filter-icon">üî¢</span>
          Fedora Version
        </label>
        <select id="version-filter" class="filter-select">
          <option value="all">All Versions</option>
          {versions.map(version => (
            <option value={version}>Fedora {version}</option>
          ))}
        </select>
      </div>

      <div class="filter-group">
        <label for="arch-filter">
          <span class="filter-icon">‚öôÔ∏è</span>
          Architecture
        </label>
        <select id="arch-filter" class="filter-select">
          <option value="all">All Architectures</option>
          {architectures.map(arch => (
            <option value={arch}>{arch}</option>
          ))}
        </select>
      </div>

      <button id="reset-filters" class="reset-button">
        Reset Filters
      </button>
    </section>

    <!-- Trend Summary Cards -->
    <section class="summary-section">
      <div class="summary-card">
        <div class="summary-icon">üìä</div>
        <div class="summary-content">
          <div class="summary-label">Total Composes</div>
          <div class="summary-value" id="total-composes">{composeIds.length}</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon">‚úÖ</div>
        <div class="summary-content">
          <div class="summary-label">Average Pass Rate</div>
          <div class="summary-value" id="avg-pass-rate">
            {formatPercent(
              trendData.reduce((sum, d) => sum + d.passed, 0),
              trendData.reduce((sum, d) => sum + d.total, 0)
            )}
          </div>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-icon">üìà</div>
        <div class="summary-content">
          <div class="summary-label">Latest Trend</div>
          <div class="summary-value trend-indicator" id="trend-indicator">
            {trendData.length >= 2 && trendData[0].passRate > trendData[1].passRate ? '‚ÜóÔ∏è Improving' : 
             trendData.length >= 2 && trendData[0].passRate < trendData[1].passRate ? '‚ÜòÔ∏è Declining' : 
             '‚Üí Stable'}
          </div>
        </div>
      </div>
    </section>

    <!-- Trend Visualization -->
    <section class="trend-chart-section">
      <h2 class="section-title">Pass Rate Trend</h2>
      <div class="chart-container" id="trend-chart">
        <div class="trend-table">
          <table>
            <thead>
              <tr>
                <th>Compose ID</th>
                <th>Version</th>
                <th>Architecture</th>
                <th>Pass Rate</th>
                <th>Passed</th>
                <th>Failed</th>
                <th>Skipped</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="trend-tbody">
              {trendData.map(data => (
                <tr class="trend-row" data-version={data.version} data-arch={data.architecture}>
                  <td class="compose-cell">
                    <a href={`/dashboard/results/${data.composeId}/${data.architecture}`}>
                      {data.composeId}
                    </a>
                  </td>
                  <td>Fedora {data.version}</td>
                  <td class="arch-cell">{data.architecture}</td>
                  <td>
                    <div class="pass-rate-bar">
                      <div class="pass-rate-fill" style={`width: ${data.passRate}%`}></div>
                      <span class="pass-rate-text">{data.passRate.toFixed(1)}%</span>
                    </div>
                  </td>
                  <td class="stat-passed">{data.passed}</td>
                  <td class="stat-failed">{data.failed}</td>
                  <td class="stat-skipped">{data.skipped}</td>
                  <td class="stat-total">{data.total}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Comparison Section -->
    <section class="comparison-section">
      <h2 class="section-title">Version Comparison</h2>
      <div class="comparison-grid" id="comparison-grid">
        {versions.map(version => {
          const versionResults = trendData.filter(d => d.version === version);
          const avgPassRate = versionResults.reduce((sum, d) => sum + d.passRate, 0) / versionResults.length;
          const totalTests = versionResults.reduce((sum, d) => sum + d.total, 0);
          const totalPassed = versionResults.reduce((sum, d) => sum + d.passed, 0);
          
          return (
            <div class="version-card" data-version={version}>
              <h3>Fedora {version}</h3>
              <div class="version-stats">
                <div class="version-stat">
                  <span class="stat-label">Avg Pass Rate</span>
                  <span class="stat-value pass-rate">{avgPassRate.toFixed(1)}%</span>
                </div>
                <div class="version-stat">
                  <span class="stat-label">Total Tests</span>
                  <span class="stat-value">{totalTests}</span>
                </div>
                <div class="version-stat">
                  <span class="stat-label">Composes</span>
                  <span class="stat-value">{versionResults.length / architectures.length}</span>
                </div>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style={`width: ${avgPassRate}%; background: ${avgPassRate >= 80 ? '#059669' : avgPassRate >= 60 ? '#d97706' : '#dc2626'}`}></div>
              </div>
            </div>
          );
        })}
      </div>
    </section>

    <!-- Back to Dashboard -->
    <nav class="bottom-nav">
      <a href="/dashboard" class="nav-link">‚Üê Back to Dashboard</a>
    </nav>
  </main>
</Layout>

<script define:vars={{ trendData }}>
  // Client-side filtering
  const versionFilter = document.getElementById('version-filter');
  const archFilter = document.getElementById('arch-filter');
  const resetButton = document.getElementById('reset-filters');
  const trendRows = document.querySelectorAll('.trend-row');
  const versionCards = document.querySelectorAll('.version-card');

  function applyFilters() {
    const selectedVersion = versionFilter.value;
    const selectedArch = archFilter.value;
    
    let visibleCount = 0;
    let totalPassed = 0;
    let totalTests = 0;

    trendRows.forEach(row => {
      const rowVersion = row.getAttribute('data-version');
      const rowArch = row.getAttribute('data-arch');
      
      const versionMatch = selectedVersion === 'all' || rowVersion === selectedVersion;
      const archMatch = selectedArch === 'all' || rowArch === selectedArch;
      
      if (versionMatch && archMatch) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    // Update version cards visibility
    versionCards.forEach(card => {
      const cardVersion = card.getAttribute('data-version');
      if (selectedVersion === 'all' || cardVersion === selectedVersion) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });

    // Update summary stats based on visible rows
    const visibleData = trendData.filter(d => {
      const versionMatch = selectedVersion === 'all' || d.version === selectedVersion;
      const archMatch = selectedArch === 'all' || d.architecture === selectedArch;
      return versionMatch && archMatch;
    });

    if (visibleData.length > 0) {
      totalPassed = visibleData.reduce((sum, d) => sum + d.passed, 0);
      totalTests = visibleData.reduce((sum, d) => sum + d.total, 0);
      const avgPassRate = ((totalPassed / totalTests) * 100).toFixed(1);
      
      document.getElementById('total-composes').textContent = new Set(visibleData.map(d => d.composeId)).size;
      document.getElementById('avg-pass-rate').textContent = avgPassRate + '%';
      
      // Update trend indicator
      if (visibleData.length >= 2) {
        const latest = visibleData[0].passRate;
        const previous = visibleData[1].passRate;
        const trendText = latest > previous ? '‚ÜóÔ∏è Improving' : 
                         latest < previous ? '‚ÜòÔ∏è Declining' : '‚Üí Stable';
        document.getElementById('trend-indicator').textContent = trendText;
      }
    }
  }

  versionFilter.addEventListener('change', applyFilters);
  archFilter.addEventListener('change', applyFilters);
  
  resetButton.addEventListener('click', () => {
    versionFilter.value = 'all';
    archFilter.value = 'all';
    applyFilters();
  });
</script>

<style>
  .trends-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* Header with Logos */
  .trends-header {
    margin-bottom: 3rem;
    text-align: center;
  }

  .logo-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1.5rem;
  }

  .logo-container {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .fedora-logo {
    width: 60px;
    height: 60px;
  }

  .azure-logo {
    width: 50px;
    height: 50px;
  }

  .brand-name {
    font-size: 1.75rem;
    font-weight: 700;
    color: #294172;
  }

  .powered-by {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .powered-text {
    font-size: 1.25rem;
    color: #6b7280;
    font-style: italic;
  }

  .header-content h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: #294172;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    font-size: 1.125rem;
    color: #6b7280;
  }

  /* Filter Section */
  .filter-section {
    display: flex;
    gap: 1.5rem;
    align-items: flex-end;
    justify-content: center;
    flex-wrap: wrap;
    padding: 2rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 200px;
  }

  .filter-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
  }

  .filter-icon {
    font-size: 1.25rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 1rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-select:hover {
    border-color: #3c6eb4;
  }

  .filter-select:focus {
    outline: none;
    border-color: #294172;
    box-shadow: 0 0 0 3px rgba(60, 110, 180, 0.1);
  }

  .reset-button {
    padding: 0.75rem 1.5rem;
    background: #f3f4f6;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .reset-button:hover {
    background: #e5e7eb;
    transform: translateY(-1px);
  }

  /* Summary Cards */
  .summary-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .summary-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1.5rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .summary-icon {
    font-size: 3rem;
  }

  .summary-content {
    flex: 1;
  }

  .summary-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .summary-value {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
  }

  .trend-indicator {
    font-size: 1.5rem;
  }

  /* Chart Section */
  .trend-chart-section {
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #294172;
    margin-bottom: 1.5rem;
  }

  .chart-container {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .trend-table {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
  }

  th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  td {
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
  }

  .trend-row:hover {
    background: #f9fafb;
  }

  .compose-cell a {
    color: #3c6eb4;
    text-decoration: none;
    font-weight: 500;
  }

  .compose-cell a:hover {
    text-decoration: underline;
  }

  .arch-cell {
    font-family: monospace;
    font-weight: 600;
  }

  .pass-rate-bar {
    position: relative;
    width: 100%;
    height: 32px;
    background: #f3f4f6;
    border-radius: 0.375rem;
    overflow: hidden;
  }

  .pass-rate-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: linear-gradient(90deg, #059669, #10b981);
    transition: width 0.3s ease;
  }

  .pass-rate-text {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-weight: 700;
    color: #111827;
    font-size: 0.875rem;
    z-index: 1;
  }

  .stat-passed {
    color: #059669;
    font-weight: 600;
  }

  .stat-failed {
    color: #dc2626;
    font-weight: 600;
  }

  .stat-skipped {
    color: #d97706;
    font-weight: 600;
  }

  .stat-total {
    font-weight: 600;
    color: #111827;
  }

  /* Version Comparison */
  .comparison-section {
    margin-bottom: 3rem;
  }

  .comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .version-card {
    padding: 1.5rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .version-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .version-card h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #294172;
    margin-bottom: 1rem;
  }

  .version-stats {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .version-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stat-label {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .stat-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
  }

  .stat-value.pass-rate {
    color: #059669;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: #f3f4f6;
    border-radius: 9999px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 9999px;
  }

  /* Bottom Navigation */
  .bottom-nav {
    text-align: center;
    padding: 2rem 0;
  }

  .nav-link {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #294172;
    color: white;
    text-decoration: none;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .nav-link:hover {
    background: #3c6eb4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(41, 65, 114, 0.3);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .logo-section {
      flex-direction: column;
      gap: 1rem;
    }

    .header-content h1 {
      font-size: 1.75rem;
    }

    .filter-section {
      flex-direction: column;
      align-items: stretch;
    }

    .summary-section {
      grid-template-columns: 1fr;
    }

    .comparison-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</Layout>
