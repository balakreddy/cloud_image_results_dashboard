---
interface DailyData {
  date: string;
  total: number;
  passed: number;
  failed: number;
  skipped: number;
  successRate: number;
}

interface Props {
  title: string;
  dailyData: DailyData[];
  width?: number;
  height?: number;
}

const { title, dailyData, width = 350, height = 200 } = Astro.props;

// Chart dimensions and spacing
const chartPadding = { top: 30, right: 20, bottom: 50, left: 40 };
const chartWidth = width - chartPadding.left - chartPadding.right;
const chartHeight = height - chartPadding.top - chartPadding.bottom;

const barWidth = 10; // Thin bars
const barSpacing = 0.5;
const daySpacing = Math.max(12, chartWidth / dailyData.length - (barWidth * 3 + barSpacing * 2));

// Find max value for scaling
const maxTotal = Math.max(...dailyData.map(d => d.total), 1);
const scale = chartHeight / maxTotal;

function formatDate(dateStr: string) {
  const date = new Date(dateStr);
  return `${date.getMonth() + 1}/${date.getDate()}`;
}

function getBarColor(type: 'passed' | 'failed' | 'skipped') {
  switch (type) {
    case 'passed': return '#22c55e';
    case 'failed': return '#ef4444';
    case 'skipped': return '#f59e0b';
  }
}
---

<div class="daily-bar-chart-container">
  <h3 class="chart-title">{title}</h3>
  
  <div class="chart-wrapper">
    <svg 
      width={width} 
      height={height} 
      viewBox={`0 0 ${width} ${height}`}
      class="daily-bar-chart"
    >
      <!-- Chart background -->
      <rect 
        x={chartPadding.left} 
        y={chartPadding.top}
        width={chartWidth}
        height={chartHeight}
        fill="#f9fafb"
        stroke="#e5e7eb"
        stroke-width="1"
        rx="4"
      />

      <!-- Y-axis grid lines and labels -->
      {[0, 0.25, 0.5, 0.75, 1].map(fraction => {
        const y = chartPadding.top + chartHeight - (chartHeight * fraction);
        const value = Math.round(maxTotal * fraction);
        return (
          <>
            <!-- Grid line -->
            <line
              x1={chartPadding.left}
              y1={y}
              x2={chartPadding.left + chartWidth}
              y2={y}
              stroke="#e5e7eb"
              stroke-width="0.5"
              stroke-dasharray="2,2"
            />
            <!-- Y-axis label -->
            <text
              x={chartPadding.left - 8}
              y={y + 3}
              text-anchor="end"
              class="axis-label"
            >
              {value}
            </text>
          </>
        );
      })}

      <!-- Daily data bars -->
      {dailyData.map((dayData, dayIndex) => {
        const dayX = chartPadding.left + 10 + (dayIndex * (daySpacing + (barWidth * 3) + (barSpacing * 2)));
        const baseY = chartPadding.top + chartHeight;

        const { passed, failed, skipped, total } = dayData;
        const passedHeight = passed * scale;
        const failedHeight = failed * scale;
        const skippedHeight = skipped * scale;

        // Check if this day has any data
        const hasData = total > 0;

        return (
          <g class="day-group">
            {hasData ? (
              <>
                <!-- Passed bar -->
                {passed > 0 && (
                  <rect
                    x={dayX}
                    y={baseY - passedHeight}
                    width={barWidth}
                    height={passedHeight}
                    fill={getBarColor('passed')}
                    stroke="white"
                    stroke-width="1"
                    rx="1"
                    class="data-bar"
                  >
                    <title>Passed: {passed}</title>
                  </rect>
                )}
                
                <!-- Failed bar -->
                {failed > 0 && (
                  <rect
                    x={dayX + barWidth + barSpacing}
                    y={baseY - failedHeight}
                    width={barWidth}
                    height={failedHeight}
                    fill={getBarColor('failed')}
                    stroke="white"
                    stroke-width="1"
                    rx="1"
                    class="data-bar"
                  >
                    <title>Failed: {failed}</title>
                  </rect>
                )}
                
                <!-- Skipped bar -->
                {skipped > 0 && (
                  <rect
                    x={dayX + (barWidth + barSpacing) * 2}
                    y={baseY - skippedHeight}
                    width={barWidth}
                    height={skippedHeight}
                    fill={getBarColor('skipped')}
                    stroke="white"
                    stroke-width="1"
                    rx="1"
                    class="data-bar"
                  >
                    <title>Skipped: {skipped}</title>
                  </rect>
                )}

                <!-- Success rate label for days with data -->
                <text
                  x={dayX + (barWidth * 3 + barSpacing * 2) / 2}
                  y={baseY + 28}
                  text-anchor="middle"
                  class="success-rate-label"
                >
                  {dayData.successRate}%
                </text>
              </>
            ) : (
              <>
                <!-- No data indicator -->
                <rect
                  x={dayX}
                  y={baseY - 8}
                  width={barWidth * 3 + barSpacing * 2}
                  height={4}
                  fill="#e5e7eb"
                  rx="2"
                  class="no-data-bar"
                >
                  <title>No data available for this day</title>
                </rect>
                
                <!-- No data label -->
                <text
                  x={dayX + (barWidth * 3 + barSpacing * 2) / 2}
                  y={baseY + 28}
                  text-anchor="middle"
                  class="no-data-label"
                >
                  No Data
                </text>
              </>
            )}

            <!-- Date label (always shown) -->
            <text
              x={dayX + (barWidth * 3 + barSpacing * 2) / 2}
              y={baseY + 15}
              text-anchor="middle"
              class="date-label"
            >
              {formatDate(dayData.date)}
            </text>
          </g>
        );
      })}

      <!-- Axes -->
      <!-- X-axis -->
      <line
        x1={chartPadding.left}
        y1={chartPadding.top + chartHeight}
        x2={chartPadding.left + chartWidth}
        y2={chartPadding.top + chartHeight}
        stroke="#374151"
        stroke-width="1"
      />

      <!-- Y-axis -->
      <line
        x1={chartPadding.left}
        y1={chartPadding.top}
        x2={chartPadding.left}
        y2={chartPadding.top + chartHeight}
        stroke="#374151"
        stroke-width="1"
      />

      <!-- Y-axis title -->
      <text
        x={15}
        y={chartPadding.top + chartHeight / 2}
        text-anchor="middle"
        class="axis-title"
        transform={`rotate(-90, 15, ${chartPadding.top + chartHeight / 2})`}
      >
        Test Count
      </text>
    </svg>

    <!-- Legend -->
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style={`background-color: ${getBarColor('passed')}`}></div>
        <span>Passed</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style={`background-color: ${getBarColor('failed')}`}></div>
        <span>Failed</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style={`background-color: ${getBarColor('skipped')}`}></div>
        <span>Skipped</span>
      </div>
    </div>
  </div>
</div>

<style>
  .daily-bar-chart-container {
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    padding: 16px;
    margin: 8px;
  }
  
  .chart-title {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    text-align: center;
  }
  
  .chart-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }
  
  .daily-bar-chart {
    transition: transform 0.2s ease;
    max-width: 100%;
    height: auto;
  }
  
  .data-bar {
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  
  .axis-label {
    font-size: 10px;
    fill: #6b7280;
    font-family: system-ui, -apple-system, sans-serif;
  }

  .axis-title {
    font-size: 11px;
    fill: #374151;
    font-family: system-ui, -apple-system, sans-serif;
    font-weight: 500;
  }
  
  .date-label {
    font-size: 9px;
    fill: #6b7280;
    font-family: system-ui, -apple-system, sans-serif;
  }

  .success-rate-label {
    font-size: 8px;
    fill: #059669;
    font-family: system-ui, -apple-system, sans-serif;
    font-weight: 600;
  }

  .no-data-bar {
    opacity: 0.5;
  }

  .no-data-label {
    font-size: 8px;
    fill: #9ca3af;
    font-family: system-ui, -apple-system, sans-serif;
    font-style: italic;
  }
  
  .legend {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 8px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #374151;
  }
  
  .legend-color {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  @media (max-width: 768px) {
    .legend {
      gap: 12px;
    }
    
    .legend-item {
      font-size: 10px;
    }
  }
</style>
